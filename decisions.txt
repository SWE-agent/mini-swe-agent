# Architecture Refactoring Decisions

## Overview
Model class now responsible for parsing actions; both model and environment class
directly return list of messages to be added. Environment class is responsible for
executing the new messages and returning a list of messages to be added.

## Config Moves
- To Model: `action_regex`, `format_error_template`
- To Environment: `action_observation_template`, `timeout_template`
- Agent keeps: `system_template`, `instance_template`, `step_limit`, `cost_limit`, `output_path`

## Method Signatures
- `model.query(messages: list[dict]) -> list[dict]` - returns new messages with "action" key parsed
- `env.execute_messages(messages: list[dict]) -> list[dict]` - executes all actions, returns observation messages

## Detailed Decisions

### Q1: Message structure with parsed action
**Decision**: Add "action" key to assistant message dict
```python
{"role": "assistant", "content": "...", "action": "ls -la", "extra": {...}}
```

### Q2: Error handling
**Decision**: Model/Environment raise exceptions with preformatted messages, Agent catches.
- Model raises FormatError with rendered format_error_template
- Environment raises ExecutionTimeoutError with rendered timeout_template
- Agent catches and converts to user messages (keeps current control flow pattern)

### Q3: Termination checking
**Decision**: Agent inspects messages returned by execute_messages for MINI_SWE_AGENT_FINAL_OUTPUT

### Q4: Template rendering
**Decision**: Each class renders templates with only its own config values + local context
- No cross-class template variable sharing
- Templates use Jinja with local context (the action/output being processed)

### Q5: Exception location
**Decision**: Move FormatError and ExecutionTimeoutError to `__init__.py` (shared location)

### Q6: Multiple actions
**Decision**: execute_messages supports executing ALL actions in the messages list
- Returns multiple observation messages (one per action)

### Q7: Raw output exposure for termination check
**Decision**: Include raw output in message dict via "extra" key
```python
{"role": "user", "content": "...", "extra": {"output": "raw stdout", "returncode": 0}}
```

### Q8: Template variables
**Decision**: Templates use Jinja with local context only
- action_observation_template uses: output.returncode, output.output
- format_error_template uses: actions (the list of found actions)
- timeout_template uses: action['action'], output

## Control Flow Principle
Agent class remains in control of all control flow and deciding how to handle errors/exits.

