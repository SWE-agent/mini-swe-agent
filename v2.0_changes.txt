# mini-swe-agent v2.0 Migration Guide

**Note:** The changes in this document apply to ALL model and environment classes,
not just the specific examples mentioned. All implementations must be updated to
conform to the new protocols.

## Exception Classes Relocated

All exception classes moved from `minisweagent.agents.default` to `minisweagent.exceptions`.

### Old imports:
```python
from minisweagent.agents.default import DefaultAgent, Submitted
from minisweagent.agents.default import NonTerminatingException, FormatError, ExecutionTimeoutError
from minisweagent.agents.default import TerminatingException, LimitsExceeded
```

### New imports:
```python
from minisweagent.agents.default import DefaultAgent
from minisweagent.exceptions import Submitted, NonTerminatingException, FormatError
from minisweagent.exceptions import ExecutionTimeoutError, TerminatingException, LimitsExceeded
```

## Model Protocol Changes

**These changes apply to ALL model implementations:**
- `LitellmModel`
- `AnthropicModel`
- `OpenRouterModel`
- `PortkeyModel`
- `PortkeyResponseAPIModel`
- `LitellmResponseAPIModel`
- `RequestyModel`
- `DeterministicModel` (test model)

### `query()` return type changed
- Old: `def query(self, messages: list[dict[str, str]], **kwargs) -> dict`
- New: `def query(self, messages: list[dict[str, str]], **kwargs) -> list[dict]`

The model now returns a list of message dicts. Each message dict must include:
- `role`: "assistant"
- `content`: the text content
- `action`: the parsed action string (extracted from content)

### `get_template_vars()` removed
The `get_template_vars()` method was removed from the Model Protocol entirely.

### New config fields (added to all model configs)
```python
action_regex: str = r"```bash\s*\n(.*?)\n```"
"""Regex to extract the action from the LM's output."""
format_error_template: str = (
    "Please provide EXACTLY ONE action in triple backticks, found {{actions|length}} actions."
)
"""Template used when the LM's output is not in the expected format."""
```

### New method `parse_action()` (added to all models)
```python
def parse_action(self, content: str) -> str:
    """Parse the action from the model output. Raises FormatError if not exactly one action."""
    actions = re.findall(self.config.action_regex, content, re.DOTALL)
    if len(actions) != 1:
        raise FormatError(
            Template(self.config.format_error_template, undefined=StrictUndefined).render(actions=actions)
        )
    return actions[0].strip()
```

## Environment Protocol Changes

**These changes apply to ALL environment implementations:**
- `LocalEnvironment`
- `DockerEnvironment`
- `SingularityEnvironment`
- `BubblewrapEnvironment`
- `SwerexDockerEnvironment`

### New config fields (added to all environment configs)
```python
action_observation_template: str = (
    "<returncode>{{output.returncode}}</returncode>\n<output>\n{{output.output}}</output>"
)
"""Template used to render the observation after executing an action."""
timeout_template: str = "Command timed out. Output:\n{{output}}"
"""Template used when a command timed out."""
```

### New method `execute_messages()` (added to all environments)
Added: `def execute_messages(self, messages: list[dict]) -> list[dict]`

This method:
1. Iterates through messages looking for `action` key
2. Executes each action via `execute()`
3. Handles timeout errors using `timeout_template`
4. Checks for task completion via `check_finished()`
5. Returns observation messages formatted via `format_observation()`

### New method `format_observation()` (added to all environments)
```python
def format_observation(self, output: dict) -> list[dict]:
    """Format output as observation message(s)."""
    content = Template(self.config.action_observation_template, undefined=StrictUndefined).render(output=output)
    return [{"role": "user", "content": content, "extra": output}]
```

### New method `check_finished()` (added to all environments)
```python
def check_finished(self, output: dict):
    """Raises Submitted exception if the output indicates task completion."""
    lines = output.get("output", "").lstrip().splitlines(keepends=True)
    if lines and lines[0].strip() == "COMPLETE_TASK_AND_SUBMIT_FINAL_OUTPUT":
        raise Submitted("".join(lines[1:]))
```

## AgentConfig Changes

### Removed fields (moved elsewhere):
- `timeout_template` → moved to environment config
- `format_error_template` → moved to model config
- `action_observation_template` → moved to environment config
- `action_regex` → moved to model config

## DefaultAgent Method Changes

### `add_message()` → `add_messages()`
- Old: `def add_message(self, role: str, content: str, **kwargs)`
- New: `def add_messages(self, messages: list[dict])`

### `query()` return type changed
- Old: `def query(self) -> dict`
- New: `def query(self) -> list[dict]`

### `step()` return type changed
- Old: `def step(self) -> dict`
- New: `def step(self)` (no return value)

### Removed methods:
- `get_observation(response: dict) -> dict` - logic moved to environment
- `parse_action(response: dict) -> dict` - logic moved to model
- `execute_action(action: dict) -> dict` - replaced by `execute_actions()`
- `has_finished(output: dict[str, str])` - logic moved to environment

### New method:
- `def execute_actions(self, messages: list[dict]) -> list[dict]`
  Calls `self.env.execute_messages(messages)` and adds results via `add_messages()`

## LocalEnvironment Config Changes

(See "Environment Protocol Changes" above for full details on config fields and methods added to all environments.)

## LitellmModel Config Changes

(See "Model Protocol Changes" above for full details on config fields and methods added to all models.)

## YAML Configuration Structure Changes

Templates moved between sections:

### Moved from `agent:` to `environment:`:
- `action_observation_template`
- `timeout_template`

### Moved from `agent:` to `model:`:
- `format_error_template`
- `action_regex`

### Example old structure:
```yaml
agent:
  system_template: "..."
  instance_template: "..."
  action_observation_template: "..."
  format_error_template: "..."
  timeout_template: "..."
  action_regex: "..."
  step_limit: 0
  cost_limit: 3.
environment:
  cwd: "..."
model:
  model_name: "..."
```

### Example new structure:
```yaml
agent:
  system_template: "..."
  instance_template: "..."
  step_limit: 0
  cost_limit: 3.
environment:
  cwd: "..."
  action_observation_template: "..."
  timeout_template: "..."
model:
  model_name: "..."
  format_error_template: "..."
  action_regex: "..."
```

## Interactive Agent Changes

### `add_message()` → `add_messages()`
Now iterates through list of messages and prints each.

### `query()` return type
Returns `list[dict]` with message containing `action` key for human input:
```python
return [{"role": "assistant", "content": f"\n```bash\n{command}\n```", "action": command}]
```

### `execute_action()` → `execute_actions()`
- Iterates through messages looking for `action` key
- Handles confirmation per action
- Handles `Submitted` exception for `confirm_exit` flow

### `has_finished()` removed
Logic merged into `execute_actions()`.

## Message Structure

Model query now returns messages with `action` key:
```python
[{
    "role": "assistant",
    "content": "...",
    "action": "parsed_command_here",
    "extra": {"response": ...}
}]
```

Environment observation messages include `extra` key:
```python
[{
    "role": "user",
    "content": "rendered_observation",
    "extra": {"output": "...", "returncode": 0}
}]
```

